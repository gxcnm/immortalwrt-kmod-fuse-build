name: Build kmod-fuse (apk) for 360V6 (ImmortalWrt)

# 手动触发编译
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 环境准备（适配Alpine/apk构建，修复apk-tools安装）
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # 清理冗余依赖
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt update -y
          sudo apt full-upgrade -y
          # 安装基础构建依赖（移除apk-tools，后续手动编译）
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget curl autoconf automake libtool
          # 手动编译安装apk-tools（GitHub Actions Ubuntu 22.04 兼容方案）
          git clone https://github.com/alpinelinux/apk-tools.git
          cd apk-tools
          ./autogen.sh
          ./configure --prefix=/usr
          make -j$(nproc)
          sudo make install
          # 验证apk-tools安装成功
          apk --version
          # 清理编译残留+系统清理
          cd .. && rm -rf apk-tools
          sudo apt autoremove -y && sudo apt clean -y

      - name: 克隆最新ImmortalWrt源码（适配apk体系）
        run: |
          # 克隆切换apk后的最新源码（匹配你的commit: f9fbaa7017）
          git clone https://github.com/immortalwrt/immortalwrt.git
          cd immortalwrt
          git checkout f9fbaa7017  # 严格匹配你的固件版本
          # 更新feeds（适配apk包体系）
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          # 切换构建体系为apk（关键）
          echo "CONFIG_PACKAGE_MANAGER=apk" >> .config
          echo "CONFIG_APK_BUILD=y" >> .config

      - name: 配置编译选项（360V6 + kmod-fuse + apk）
        run: |
          cd immortalwrt
          # 加载360V6基础配置（IPQ60xx + 6.6内核）
          cp configs/qualcommax/ipq60xx/config-6.6 .config
          # 配置仅编译kmod-fuse，适配apk
          make menuconfig -o .config << EOF
          CONFIG_TARGET_qualcommax=y
          CONFIG_TARGET_qualcommax_ipq60xx=y
          CONFIG_TARGET_qualcommax_ipq60xx_DEVICE_qihoo_360v6=y
          CONFIG_PACKAGE_kmod-fuse=y
          CONFIG_PACKAGE_fuse-utils=y
          CONFIG_PACKAGE_MANAGER=apk
          CONFIG_APK_BUILD=y
          CONFIG_ALL_NONSHARED=y
          EOF
          # 生成最终配置
          make defconfig

      - name: 编译kmod-fuse（apk格式）
        run: |
          cd immortalwrt
          # 仅编译kmod-fuse和fuse-utils，加速构建
          make package/kmod-fuse/compile V=s -j$(nproc)
          make package/fuse-utils/compile V=s -j$(nproc)
          # 将ipk转换为apk（ImmortalWrt apk体系的核心步骤）
          ./scripts/ipk2apk.sh bin/targets/qualcommax/ipq60xx/packages/*.ipk
          ./scripts/ipk2apk.sh bin/packages/aarch64_cortex-a53/base/*.ipk

      - name: 提取apk格式产物
        run: |
          # 创建输出目录
          mkdir -p ./kmod-fuse-apk-output
          # 复制转换后的apk包（适配aarch64）
          find immortalwrt/bin -name "kmod-fuse-*.apk" -exec cp {} ./kmod-fuse-apk-output/ \;
          find immortalwrt/bin -name "fuse-utils-*.apk" -exec cp {} ./kmod-fuse-apk-output/ \;
          # 列出产物，确认生成成功
          ls -l ./kmod-fuse-apk-output/

      - name: 上传apk产物到GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kmod-fuse-360v6-apk
          path: ./kmod-fuse-apk-output/
