name: Build kmod-fuse for 360V6 (ImmortalWrt)

# 触发条件：手动触发
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 环境准备
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget curl
          sudo apt autoremove -y && sudo apt clean -y

      - name: 克隆ImmortalWrt源码（匹配你的版本）
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git
          cd immortalwrt
          # 切换到你固件对应的commit: f9fbaa7017（r34087）
          git checkout f9fbaa7017
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 配置编译选项（仅编译kmod-fuse）
        run: |
          cd immortalwrt
          # 加载360V6默认配置
          cp configs/qualcommax/ipq60xx/config-6.6 .config
          # 仅保留kmod-fuse相关配置，清空其他
          make menuconfig -o .config << EOF
          CONFIG_TARGET_qualcommax=y
          CONFIG_TARGET_qualcommax_ipq60xx=y
          CONFIG_TARGET_qualcommax_ipq60xx_DEVICE_qihoo_360v6=y
          CONFIG_PACKAGE_kmod-fuse=y
          CONFIG_ALL_NONSHARED=y
          EOF
          # 清理无关配置，仅编译kmod-fuse
          make defconfig

      - name: 编译kmod-fuse模块
        run: |
          cd immortalwrt
          # 仅编译kmod-fuse，加速编译
          make package/kmod-fuse/compile V=s -j$(nproc)

      - name: 提取编译产物
        run: |
          # 创建产物目录
          mkdir -p ./kmod-fuse-output
          # 复制编译好的ipk包到输出目录
          cp immortalwrt/bin/targets/qualcommax/ipq60xx/packages/kmod-fuse_*.ipk ./kmod-fuse-output/
          # 复制fuse-utils（备用）
          cp immortalwrt/bin/packages/aarch64_cortex-a53/base/fuse-utils_*.ipk ./kmod-fuse-output/ || echo "fuse-utils未编译，可忽略"

      - name: 上传产物到GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kmod-fuse-360v6
          path: ./kmod-fuse-output/
